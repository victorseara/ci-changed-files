name: Build Node.js app (pnpm)
on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Run tests
        run: pnpm test
     
      - name: Capture changes in project dependencies
        id: dependency-check-action
        uses: tj-actions/changed-files@v46.0.1
        with: 
            files: |
                package.json
                pnpm-lock.yaml
            token: ${{ secrets.GITHUB_TOKEN }}
     
      - name: Capture any changes
        id: changes-check-action
        uses: tj-actions/changed-files@v46.0.1
        with: 
            files: |
                *
            files_ignore: |
                package.json
                pnpm-lock.yaml
            token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prevent dependency updates with code changes
        if: steps.dependency-check-action.outputs.all_changed_files_count == '2' && steps.changes-check-action.outputs.any_changed == 'true'
        run: |
          echo "Dependency updates detected with code changes. Please review the changes before merging."
          exit 1
      - name: Debug outputs
        run: |
          echo "dependency-check-action outputs: ${{ toJson(steps.dependency-check-action.outputs) }}"
          echo "changes-check-action outputs: ${{ toJson(steps.changes-check-action.outputs) }}"
        shell: bash